<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Spring WebSocket 기반 채팅</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
        .main-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .chat-container {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background-color: white;
            margin-left: 1rem;
        }
        .form-control:focus {
            box-shadow: none;
            border-color: #6c757d;
        }
        .btn-custom {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        .btn-custom:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        .chat-log {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: left;
        }
        .chat-message {
            margin-bottom: 0.5rem;
        }
        .chat-message .sender {
            font-weight: bold;
            color: lightcoral;
        }
        .chat-message .content {
            word-wrap: break-word;
        }
        .user-list-container, .room-list-container {
            width: 200px;
            height: 400px;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background-color: #f8f9fa;
            text-align: left;
            overflow-y: auto;
        }
        .user-list-container h5, .room-list-container h5 {
            font-weight: bold;
            color: #495057;
            margin-bottom: 1rem;
        }
        .user-list-container ul, .room-list-container ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .user-list-container li, .room-list-container li {
            padding: 0.25rem 0;
            color: #6c757d;
        }
        .chat-view {
            display: flex;
            width: 100%;
            justify-content: center;
            align-items: center;
        }
        .input-group > *:not(:last-child) {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .input-group > *:not(:first-child) {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        .input-group .btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
    </style>
</head>
<body>
    <div id="app" class="main-container">
        <div v-if="!connected">
            <div class="chat-container p-3">
                <h2 class="mb-4 text-center">Spring WebSocket 기반 채팅</h2>
                <!-- DB 연동 하지 않고, 사용자를 직접 입력하여 채팅 진행 -->
                <div class="input-group mb-3">
                    <input type="text" v-model="username" class="form-control" placeholder="사용자명 입력" @keydown.enter.prevent="connect()">
                    <button type="button" class="btn btn-custom" @click="connect()">서버 접속</button>
                </div>
            </div>
        </div>

        <div v-else class="chat-view">
            <!--참여자 목록-->
            <div class="user-list-container me-3">
                <h5 class="text-center">참여자 목록</h5>
                <ul>
                    <li v-for="user in users">{{ user}}</li>
                </ul>
            </div>
            <div class="chat-container p-3">
                <p class="lead text-center"><b>{{username}}</b>님 접속 중</p>
                <div class="d-grid mb-3">
                    <button type="button" class="btn btn-outline-danger" @click="disconnect()">접속 종료</button>
                </div>
                <div class="input-group">
                    <div class="chat-log w-100 mb-3">
                        <!-- 예시 메시지 -->
                        <div class="chat-message" v-for="msg in msgs">
                            <span class="sender">{{msg.sender}} :  </span>
                            <span class="content">{{msg.content}}</span>
                        </div>
                    </div>
                    <input type="text" v-model="message" class="form-control" placeholder="메시지를 입력하세요" @keydown.enter.prevent="sendMsg()">
                    <button type="button" class="btn btn-custom" @click="sendMsg()">전송</button>
                </div>
            </div>
            <!--방 목록-->
            <div class="room-list-container ms-3">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="방이름 입력" v-model="roomName">
                    <button type="button" class="btn btn-custom" @click="createRoom()">생성</button>
                </div>
                <h5 class="text-center">방 목록</h5>
                <ul>
                    <li v-for="room in rooms" :key="room.roomId">
                        <b>{{room.roomName}}</b>(참여자 수 : {{room.users.length}})
                        <ul>
                            <li v-for="user in room.users">{{user}}</li>
                            <button type="button" @click="enterRoom(room.roomId)"> 참여하기</button>
                            <button type="button" @click="leaveRoom(room.roomId)"> 나가기</button>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const {createApp, ref, reactive} = Vue;
        createApp({
            setup(){
                const username = ref(""); // 사용자명 바인딩 변수
                const connected= ref(false); // 접속 여부
                const message = ref("");
                const users = ref([]);
                const msgs = ref([]);
                const rooms = ref([]);
                const roomName = ref("");
                let socket = null;

                /*--------------------------------------------------------------------
                    채팅 메세지 보내기 공통 규약 설정
                ---------------------------------------------------------------------*/
                const send = (payload) =>{
                    socket.send(JSON.stringify(payload));
                }
                /*--------------------------------------------------------------------
                                        웹소켓 서버 접속
                 ---------------------------------------------------------------------*/
                const connect = ()=>{
                    if(!username.value.trim()){
                        alert("사용자명을 입력하세요");
                        return;
                    }
                    socket = new WebSocket("ws://localhost:9999/ws");
                    socket.onopen = () => {
                        // onopen 호출 되었다는 것은 성공했다는 것임.
                        connected.value = true;
                        //서버에 '나 접속했어' 라고 알리기
                        send({
                            type:"CONNECT",
                            sender:username.value
                        });

                        send({
                            type:"ROOM_LIST"
                        });
                    };

                    //서버로부터 메시지를 받을 때 실행되는 콜백
                    socket.onmessage = (e) => {
                        console.log(e.data);
                        let json = JSON.parse(e.data);
                        if(json.destination == "/users"){ //서버가 보낸 정보가 유저 목록이라면
                            users.value=json.body;
                        }else if(json.destination == "/messages"){
                            msgs.value.push(json.body);
                        }else if(json.destination == "/rooms"){
                            rooms.value=json.body;
                        }
                    }
                }



                /*--------------------------------------------------------------------
                        채팅 메세지 보내기
                ---------------------------------------------------------------------*/
                const sendMsg = ()=>{
                    if(message.value.trim()){
                        send({
                            type:"MESSAGE",
                            sender : username.value,
                            content : message.value,
                        });
                        message.value = "";
                    }
                }

                /*--------------------------------------------------------------------
                        방 만들기
                ---------------------------------------------------------------------*/
                const createRoom = () => {
                    if(roomName.value.trim()){
                        send({
                            type:"ROOM_CREATE",
                            sender : username.value,
                            content : roomName.value
                        });
                        roomName.value = "";
                    }
                }

                /*--------------------------------------------------------------------
                    방 들어가기
                ---------------------------------------------------------------------*/
                const enterRoom = (roomId) => {
                    send({
                        type:"ROOM_ENTER",
                        sender : username.value,
                        roomId : roomId
                    });
                }


                /*--------------------------------------------------------------------
                    방 나가기
                ---------------------------------------------------------------------*/
                const leaveRoom = (roomId) => {
                    send({
                        type:"ROOM_LEAVE",
                        sender : username.value,
                        roomId : roomId
                    });
                }
                /*--------------------------------------------------------------------
                        웹소켓 서버 접속 해제
                ---------------------------------------------------------------------*/
                const disconnect = ()=>{
                    if(socket) {
                        send({
                            type : "DISCONNECT",
                            sender:username.value
                        });
                        socket.close();
                        let newUsers=[];
                        //기존 유저 목록이 들어있는 배열에서 , 현재 사용자를 제거한 후
                        //최종 배열을 생성
                        for(i=0;i<users.length;i++){
                            if(users.value[i] != username.value){
                                newUsers.push(users.value[i]);
                            }
                        }
                        users.value=newUsers;
                        connected.value = false;
                    }
                }

                return{rooms,roomName,users,message, msgs,connected, username, connect, disconnect, sendMsg,createRoom,enterRoom,leaveRoom};
            }
        }).mount("#app");
    </script>

</body>
</html>