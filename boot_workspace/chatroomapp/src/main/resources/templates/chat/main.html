<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅 애플리케이션</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* --- 기존 main.html 스타일 --- */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        #wrapper {
            display: flex;
            height: 100vh;
            max-width: 100%;
            padding: 0;
            margin: 0;
        }
        #aside {
            width: 300px;
            flex-shrink: 0;
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }
        #content {
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            padding: 1.5rem;
            height: 100%;
            overflow-y: auto;
            background-color: #e9ecef;
        }
        .room {
            width: 380px;
            height: 300px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            background-color: #ffffff;
            margin-right: 1.5rem;
            margin-bottom: 1.5rem;
            cursor: pointer;
        }
        .room:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        .room_header, .room_body { padding: 1rem; }
        #userList {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 1rem;
        }

        /* --- 팝업을 위한 스타일 --- */
        #popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* 팝업을 숨기기 위한 helper class */
        .hidden {
            display: none !important;
        }

        #pop {
            width: 1000px;
            height: 90vh;
            max-height: 1000px;
            display: flex;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        .btn-close-popup {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1010;
        }

        /* --- 팝업 내부 요소 스타일 (ID 변경 적용) --- */
        #content2 {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #dee2e6;
        }
        #content_header2 {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
            height: 60px;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #content_body2 {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        #aside2 {
            width: 280px;
            flex-shrink: 0;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        #aside_header2, #aside_footer2 { padding: 1rem; border-bottom: 1px solid #dee2e6; }
        #aside_body2 { flex-grow: 1; overflow-y: auto; }
        #aside_footer2 { border-top: 1px solid #dee2e6; border-bottom: none; }

        #footer2 {
            border-top: 1px solid #dee2e6;
            flex-shrink: 0;
            padding: 1rem;
            background-color: #ffffff;
        }
        .chat-message { margin-bottom: 1rem; }
        .chat-message .sender { font-weight: bold; font-size: 0.9rem; color: #555; }
        .chat-message .message-bubble { display: inline-block; max-width: 80%; padding: 0.5rem 0.8rem; border-radius: 1rem; background-color: #d1d8e0; }
        .chat-message.my-message { text-align: right; }
        .chat-message.my-message .message-bubble { background-color: #0d6efd; color: white; }
    </style>
</head>
<body class="d-flex flex-column vh-100">
<div id="app">
    <div id="wrapper">
        <div id="aside">
            <div th:if="${session.member != null}">
                <h4 th:text="|${session.member.name} 님|"></h4>
            </div>
            <h5 class="fw-bold"><i class="bi bi-chat-dots-fill"></i> 채팅방 목록</h5>
            <div class="input-group mb-3">
                <input type="hidden" th:value="${session.member.id}" name="id">
                <input type="text" class="form-control" placeholder="방 제목 설정" name="roomName">
                <button class="btn btn-primary" type="button" @click="createRoom()">방 만들기</button>
            </div>
            <h5 class="fw-bold mt-4"><i class="bi bi-people-fill"></i> 접속자 목록</h5>
            <div id="userList" class="list-group">
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-for ="member in memberList">
                    {{member.name}}
                    <span class="badge bg-primary rounded-pill">online</span>
                </a>
            </div>
        </div>
        <div id="content">
            <div class="room" v-for="room in roomList">
                <div class="room_header"><span>{{room.roomName}}</span></div>
                <div class="room_body"><p>참여자: {{ room.users.length }}명</p></div>
            </div>
        </div>

        <div id="popup-overlay" class="hidden">
            <div id="pop">
                <button type="button" class="btn-close btn-close-popup"></button>
                <div id="content2">
                    <div id="content_header2"></div>
                    <div id="content_body2">
                        <div class="chat-message">
                            <div class="sender">상대방 이름</div>
                            <div class="message-bubble">상대방이 보낸 메시지 내용</div>
                        </div>
                        <div class="chat-message my-message">
                            <div class="message-bubble">내가 보낸 메시지 내용</div>
                        </div>
                    </div>
                    <div id="footer2">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="메시지를 입력하세요...">
                            <button class="btn btn-primary" type="button">보내기</button>
                        </div>
                    </div>
                </div>
                <div id="aside2">
                    <div id="aside_header2">
                        <span class="fw-bold">내 이름: </span>
                        <span th:text="${session.member.name}"></span>
                    </div>
                    <div id="aside_body2" class="list-group list-group-flush">
                        <div class="list-group-item fw-bold border-bottom">
                            <i class="bi bi-people-fill"></i> 참여자
                        </div>
                    </div>
                    <div id="aside_footer2">
                        <button class="btn btn-danger w-100">나가기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const {createApp, reactive, ref} = Vue;
    /** @vue/component */
    createApp({
        setup() {
            // 로비 관련 데이터 및 로직
            const roomList = reactive([]);
            const memberList = reactive([]);
            let ws = null;

            const connect = () => {
                ws = new WebSocket('ws://localhost:8989/chat/multi');

                ws.onopen = () => {
                    console.log("WebSocket Connected");
                };

                ws.onmessage = (e) => {
                    console.log("Message received:", e.data);
                    const responseJson = JSON.parse(e.data);

                    if(responseJson.responseType == "connect" || responseJson.responseType == "createRoom"){
                        //접속자 명단 채우기
                        memberList.splice(0); // 배열 비우기
                        responseJson.memberList.forEach(member => {
                            memberList.push(member);
                        });

                        //채팅방 목록 채우기
                        roomList.splice(0); // 배열 비우기
                        if(responseJson.roomList != null){
                            responseJson.roomList.forEach(room => {
                                roomList.push(room);
                            });
                        }
                    }
                };
            };

            const request = (data) => {
                ws.send(data);
            };

            const createRoom = () => {
                let payload = {
                    requestType:"createRoom",
                    userId:$("input[name='id']").val(),
                    roomName:$("input[name='roomName']").val(),
                };
                request(JSON.stringify(payload));
            };

            connect();

            // 팝업 관련 로직은 여기에서 직접 구현하시면 됩니다.

            return {
                memberList,
                roomList,
                request,
                connect,
                createRoom,
            };
        }
    }).mount("#app");
</script>
</body>
</html>