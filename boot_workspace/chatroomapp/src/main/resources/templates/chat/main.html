<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅 애플리케이션</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* --- 기본 레이아웃 스타일 --- */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        #wrapper {
            display: flex;
            height: 100vh;
            max-width: 100%;
            padding: 0;
            margin: 0;
        }
        #aside {
            width: 300px;
            flex-shrink: 0;
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }
        #content {
            flex-grow: 1;
            display: flex; /* 자식 요소가 flex item이 되도록 설정 */
            padding: 1.5rem;
            height: 100%;
            overflow-y: auto;
            background-color: #e9ecef;
        }
        #userList {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 1rem;
        }

        /* --- 채팅방 목록 스타일 --- */
        #room-list-container {
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            width: 100%;
        }
        .room {
            width: 380px;
            height: 300px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            background-color: #ffffff;
            margin-right: 1.5rem;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .room:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        .room_header, .room_body { padding: 1rem; }

        /* --- 채팅창 UI 스타일 --- */
        #chat-room-view {
            width: 100%;
            height: 100%;
            display: flex;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative; /* 닫기 버튼 위치 지정을 위해 relative 설정 */
        }
        #chat-room-view .btn-close {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
        }

        /* --- 채팅창 내부 요소 스타일 --- */
        #content2 {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #dee2e6;
        }
        #content_header2 {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
            height: 60px;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #content_body2 {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        #footer2 {
            border-top: 1px solid #dee2e6;
            flex-shrink: 0;
            padding: 1rem;
            background-color: #ffffff;
        }
        #aside2 {
            width: 280px;
            flex-shrink: 0;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        #aside_header2, #aside_footer2 { padding: 1rem; border-bottom: 1px solid #dee2e6; }
        #aside_body2 { flex-grow: 1; overflow-y: auto; }
        #aside_footer2 { border-top: 1px solid #dee2e6; border-bottom: none; }

        /* --- 채팅 메시지 스타일 --- */
        .chat-message { margin-bottom: 1rem; }
        .chat-message .sender { font-weight: bold; font-size: 0.9rem; color: #555; }
        .chat-message .message-bubble { display: inline-block; max-width: 80%; padding: 0.5rem 0.8rem; border-radius: 1rem; background-color: #d1d8e0; }
        .chat-message.my-message { text-align: right; }
        .chat-message.my-message .message-bubble { background-color: #0d6efd; color: white; }
    </style>
</head>
<body class="d-flex flex-column vh-100">
<div id="app">
    <div id="wrapper">
        <div id="aside">
            <div th:if="${session.member != null}">
                <h4 th:text="|${session.member.name} 님|"></h4>
            </div>
            <h5 class="fw-bold"><i class="bi bi-chat-dots-fill"></i> 채팅방 목록</h5>
            <div class="input-group mb-3">
                <input type="hidden" th:value="${session.member.id}" name="id">
                <input type="hidden" th:value="${session.member.name}" name="senderName">
                <input type="text" class="form-control" placeholder="방 제목 설정" name="roomName">
                <button class="btn btn-primary" type="button" @click="createRoom()">방 만들기</button>
            </div>
            <h5 class="fw-bold mt-4"><i class="bi bi-people-fill"></i> 접속자 목록</h5>
            <div id="userList" class="list-group">
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-for ="member in memberList">
                    {{member.name}}
                    <span class="badge bg-primary rounded-pill">online</span>
                </a>
            </div>
        </div>
        <div id="content">
            <div id="room-list-container" v-if="!currentRoom">
                <div class="room" v-for="room in roomList" @click="enterRoom(room)" key="room.uuid">
                    <div class="room_header"><span>{{room.roomName}}</span></div>
                    <div class="room_body"><p>참여자: {{ room.users.length }}명</p></div>
                </div>
            </div>
            <div id="chat-room-view" v-if="currentRoom">
                <button type="button" class="btn-close" @click="leaveRoom"></button>
                <div id="content2">
                    <div id="content_header2">{{ currentRoom.roomName }}</div>
                    <div id="content_body2" ref="messageContainer">
                        <div v-for="msg in messages" :key="msg.id"
                             class="chat-message"
                             :class="{'my-message': msg.senderId === currentUserId}">
                            <div v-if="msg.senderId !== currentUserId" class="sender">{{ msg.senderName }}</div>
                            <div class="message-bubble">{{ msg.text }}</div>
                        </div>

                    </div>
                    <div id="footer2">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="메시지를 입력하세요..." @keydown.enter.prevent="sendMessage()" v-model="msg">
                            <button class="btn btn-primary" type="button" @click="sendMessage()">보내기</button>
                        </div>
                    </div>
                </div>
                <div id="aside2">
                    <div id="aside_header2">
                        <span class="fw-bold">방장: </span>
                        <span v-if="currentRoom">{{currentRoom.master}}</span>
                    </div>
                    <div id="aside_body2" class="list-group list-group-flush">
                        <div class="list-group-item fw-bold border-bottom">
                            <i class="bi bi-people-fill"></i> 참여자
                        </div>
                        <div class="list-group-item" v-for="user in currentRoom.users" key="user.id">{{ user.name }}</div>
                    </div>
                    <div id="aside_footer2">
                        <button class="btn btn-danger w-100" @click="leaveRoom">나가기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const {createApp, reactive, ref, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // 로비 관련 데이터
            const roomList = reactive([]);
            const memberList = reactive([]);
            let ws = null;

            // 🎨 [추가] 채팅방 UI 제어를 위한 상태와 로직
            const currentRoom = ref(null); // 현재 입장한 방의 정보를 저장. null이면 로비를 보여줌.

            //채팅방 내용
            let msg = ref(""); //전송할 채팅 메세지
            let uuid = ref("");
            // 1. 모든 채팅 메시지를 저장할 반응형 배열
            const messages = reactive([]);

            // 2. 현재 로그인한 사용자의 ID를 저장할 변수 (내 메시지인지 구분하기 위함)
            const currentUserId = ref("");

            // 3. 스크롤을 제어할 엘리먼트를 참조하기 위한 ref
            const messageContainer = ref(null);

            // 4. messages 배열에 새 메시지를 추가하는 함수
            const addMessage = (msg) => {
                messages.push(msg);
            };

            //  messages 배열에 변화가 생길 때마다 자동으로 맨 아래로 스크롤
            watch(messages, () => {
                // nextTick: Vue가 DOM 업데이트를 완료한 직후에 코드를 실행하도록 보장
                nextTick(() => {
                    if (messageContainer.value) {
                        messageContainer.value.scrollTop = messageContainer.value.scrollHeight;
                    }
                });
            });

            // 컴포넌트가 화면에 마운트된 후 실행될 코드 (내 메세지인지 , 상대 메세지인지 구분하기 위함)
            onMounted(() => {
                // Thymeleaf가 렌더링한 hidden input에서 현재 사용자 ID를 가져옴
                currentUserId.value = document.querySelector("input[name='id']").value;
            });

            const enterRoom = (room) => {
                currentRoom.value = room;
                messages.splice(0);
                let payload={
                    requestType: "enterRoom",
                    uuid: room.uuid
                }
                request(JSON.stringify(payload));
            };

            const leaveRoom = () => {
                currentRoom.value = null;
                // TODO: 방에서 나가는 WebSocket 요청 로직 추가
            };

            // WebSocket 관련 로직
            const connect = () => {
                ws = new WebSocket('ws://192.168.60.37:8989/chat/multi');

                ws.onopen = () => {
                    console.log("WebSocket Connected");
                };

                ws.onmessage = (e) => {
                    console.log("Message received:", e.data);
                    const responseJson = JSON.parse(e.data);

                    if(responseJson.responseType == "connect" || responseJson.responseType == "createRoom"){
                        //접속자 명단 채우기
                        memberList.splice(0); // 배열 비우기
                        responseJson.memberList.forEach(member => {
                            memberList.push(member);
                        });

                        //채팅방 목록 채우기
                        roomList.splice(0); // 배열 비우기
                        if(responseJson.roomList != null){
                            responseJson.roomList.forEach(room => {
                                roomList.push(room);
                            });
                        }
                    }else if(responseJson.responseType == "enterRoom"){
                        console.log(responseJson);
                        uuid.value = responseJson.room.uuid;
                    }else if(responseJson.responseType == "leaveRoom"){

                    }else if(responseJson.responseType == "chat"){
                        const newMessage = {
                            id : responseJson.messageId,
                            senderId : responseJson.senderId,
                            senderName : responseJson.senderName,
                            text : responseJson.data
                        };
                        addMessage(newMessage);

                    }
                    // TODO: 채팅 메시지 수신 등 다른 타입의 메시지 처리 로직 추가
                };
            };

            const disconnect = () => {
                ws.disconnect();
            }

            const request = (data) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(data);
                } else {
                    console.error("WebSocket is not connected.");
                }
            };

            const createRoom = () => {
                const roomNameInput = $("input[name='roomName']");
                if (!roomNameInput.val()) {
                    alert("방 제목을 입력해주세요.");
                    return;
                }
                let payload = {
                    requestType:"createRoom",
                    userId:$("input[name='id']").val(),
                    roomName: roomNameInput.val(),
                };
                request(JSON.stringify(payload));
                roomNameInput.val(''); // 입력 필드 초기화
            };

            const sendMessage = () => {
                if (!msg.value || msg.value.trim() === "") {
                    return; // 메시지가 비어있으면 함수를 그냥 종료
                }
                let payload = {
                    requestType: "chat",
                    senderId:$("input[name='id']").val(),
                    senderName:$("input[name='senderName']").val(),
                    data:msg.value,
                    uuid: uuid.value
                }
                request(JSON.stringify(payload));
                msg.value = ""; //바인딩 변수이므로 UI에 자동 반영.
            }

            connect();

            // 템플릿에서 사용할 데이터와 함수들을 반환
            return {
                memberList,
                roomList,
                request,
                connect,
                createRoom,
                sendMessage,
                msg,
                uuid,
                messages,
                currentUserId,
                messageContainer,
                addMessage,

                // 🎨 [추가] UI 제어용 상태와 함수 반환
                currentRoom,
                enterRoom,
                leaveRoom,
                disconnect

            };
        }
    }).mount("#app");
</script>
</body>
</html>