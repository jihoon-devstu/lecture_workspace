<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… ì• í”Œë¦¬ì¼€ì´ì…˜</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* --- ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ --- */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        #wrapper {
            display: flex;
            height: 100vh;
            max-width: 100%;
            padding: 0;
            margin: 0;
        }
        #aside {
            width: 300px;
            flex-shrink: 0;
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }
        #content {
            flex-grow: 1;
            display: flex; /* ìì‹ ìš”ì†Œê°€ flex itemì´ ë˜ë„ë¡ ì„¤ì • */
            padding: 1.5rem;
            height: 100%;
            overflow-y: auto;
            background-color: #e9ecef;
        }
        #userList {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 1rem;
        }

        /* --- ì±„íŒ…ë°© ëª©ë¡ ìŠ¤íƒ€ì¼ --- */
        #room-list-container {
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            width: 100%;
        }
        .room {
            width: 380px;
            height: 300px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            background-color: #ffffff;
            margin-right: 1.5rem;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .room:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        .room_header, .room_body { padding: 1rem; }

        /* --- ì±„íŒ…ì°½ UI ìŠ¤íƒ€ì¼ --- */
        #chat-room-view {
            width: 100%;
            height: 100%;
            display: flex;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative; /* ë‹«ê¸° ë²„íŠ¼ ìœ„ì¹˜ ì§€ì •ì„ ìœ„í•´ relative ì„¤ì • */
        }
        #chat-room-view .btn-close {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
        }

        /* --- ì±„íŒ…ì°½ ë‚´ë¶€ ìš”ì†Œ ìŠ¤íƒ€ì¼ --- */
        #content2 {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #dee2e6;
        }
        #content_header2 {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
            height: 60px;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #content_body2 {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        #footer2 {
            border-top: 1px solid #dee2e6;
            flex-shrink: 0;
            padding: 1rem;
            background-color: #ffffff;
        }
        #aside2 {
            width: 280px;
            flex-shrink: 0;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        #aside_header2, #aside_footer2 { padding: 1rem; border-bottom: 1px solid #dee2e6; }
        #aside_body2 { flex-grow: 1; overflow-y: auto; }
        #aside_footer2 { border-top: 1px solid #dee2e6; border-bottom: none; }

        /* --- ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ --- */
        .chat-message { margin-bottom: 1rem; }
        .chat-message .sender { font-weight: bold; font-size: 0.9rem; color: #555; }
        .chat-message .message-bubble { display: inline-block; max-width: 80%; padding: 0.5rem 0.8rem; border-radius: 1rem; background-color: #d1d8e0; }
        .chat-message.my-message { text-align: right; }
        .chat-message.my-message .message-bubble { background-color: #0d6efd; color: white; }
    </style>
</head>
<body class="d-flex flex-column vh-100">
<div id="app">
    <div id="wrapper">
        <div id="aside">
            <div th:if="${session.member != null}">
                <h4 th:text="|${session.member.name} ë‹˜|"></h4>
            </div>
            <h5 class="fw-bold"><i class="bi bi-chat-dots-fill"></i> ì±„íŒ…ë°© ëª©ë¡</h5>
            <div class="input-group mb-3">
                <input type="hidden" th:value="${session.member.id}" name="id">
                <input type="hidden" th:value="${session.member.name}" name="senderName">
                <input type="text" class="form-control" placeholder="ë°© ì œëª© ì„¤ì •" name="roomName">
                <button class="btn btn-primary" type="button" @click="createRoom()">ë°© ë§Œë“¤ê¸°</button>
            </div>
            <h5 class="fw-bold mt-4"><i class="bi bi-people-fill"></i> ì ‘ì†ì ëª©ë¡</h5>
            <div id="userList" class="list-group">
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-for ="member in memberList">
                    {{member.name}}
                    <span class="badge bg-primary rounded-pill">online</span>
                </a>
            </div>
        </div>
        <div id="content">
            <div id="room-list-container" v-if="!currentRoom">
                <div class="room" v-for="room in roomList" @click="enterRoom(room)" key="room.uuid">
                    <div class="room_header"><span>{{room.roomName}}</span></div>
                    <div class="room_body"><p>ì°¸ì—¬ì: {{ room.users.length }}ëª…</p></div>
                </div>
            </div>
            <div id="chat-room-view" v-if="currentRoom">
                <button type="button" class="btn-close" @click="leaveRoom"></button>
                <div id="content2">
                    <div id="content_header2">{{ currentRoom.roomName }}</div>
                    <div id="content_body2" ref="messageContainer">
                        <div v-for="msg in messages" :key="msg.id"
                             class="chat-message"
                             :class="{'my-message': msg.senderId === currentUserId}">
                            <div v-if="msg.senderId !== currentUserId" class="sender">{{ msg.senderName }}</div>
                            <div class="message-bubble">{{ msg.text }}</div>
                        </div>

                    </div>
                    <div id="footer2">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." @keydown.enter.prevent="sendMessage()" v-model="msg">
                            <button class="btn btn-primary" type="button" @click="sendMessage()">ë³´ë‚´ê¸°</button>
                        </div>
                    </div>
                </div>
                <div id="aside2">
                    <div id="aside_header2">
                        <span class="fw-bold">ë°©ì¥: </span>
                        <span v-if="currentRoom">{{currentRoom.master}}</span>
                    </div>
                    <div id="aside_body2" class="list-group list-group-flush">
                        <div class="list-group-item fw-bold border-bottom">
                            <i class="bi bi-people-fill"></i> ì°¸ì—¬ì
                        </div>
                        <div class="list-group-item" v-for="user in currentRoom.users" key="user.id">{{ user.name }}</div>
                    </div>
                    <div id="aside_footer2">
                        <button class="btn btn-danger w-100" @click="leaveRoom">ë‚˜ê°€ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const {createApp, reactive, ref, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // ë¡œë¹„ ê´€ë ¨ ë°ì´í„°
            const roomList = reactive([]);
            const memberList = reactive([]);
            let ws = null;

            // ğŸ¨ [ì¶”ê°€] ì±„íŒ…ë°© UI ì œì–´ë¥¼ ìœ„í•œ ìƒíƒœì™€ ë¡œì§
            const currentRoom = ref(null); // í˜„ì¬ ì…ì¥í•œ ë°©ì˜ ì •ë³´ë¥¼ ì €ì¥. nullì´ë©´ ë¡œë¹„ë¥¼ ë³´ì—¬ì¤Œ.

            //ì±„íŒ…ë°© ë‚´ìš©
            let msg = ref(""); //ì „ì†¡í•  ì±„íŒ… ë©”ì„¸ì§€
            let uuid = ref("");
            // 1. ëª¨ë“  ì±„íŒ… ë©”ì‹œì§€ë¥¼ ì €ì¥í•  ë°˜ì‘í˜• ë°°ì—´
            const messages = reactive([]);

            // 2. í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ IDë¥¼ ì €ì¥í•  ë³€ìˆ˜ (ë‚´ ë©”ì‹œì§€ì¸ì§€ êµ¬ë¶„í•˜ê¸° ìœ„í•¨)
            const currentUserId = ref("");

            // 3. ìŠ¤í¬ë¡¤ì„ ì œì–´í•  ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•œ ref
            const messageContainer = ref(null);

            // 4. messages ë°°ì—´ì— ìƒˆ ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
            const addMessage = (msg) => {
                messages.push(msg);
            };

            //  messages ë°°ì—´ì— ë³€í™”ê°€ ìƒê¸¸ ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
            watch(messages, () => {
                // nextTick: Vueê°€ DOM ì—…ë°ì´íŠ¸ë¥¼ ì™„ë£Œí•œ ì§í›„ì— ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë„ë¡ ë³´ì¥
                nextTick(() => {
                    if (messageContainer.value) {
                        messageContainer.value.scrollTop = messageContainer.value.scrollHeight;
                    }
                });
            });

            // ì»´í¬ë„ŒíŠ¸ê°€ í™”ë©´ì— ë§ˆìš´íŠ¸ëœ í›„ ì‹¤í–‰ë  ì½”ë“œ (ë‚´ ë©”ì„¸ì§€ì¸ì§€ , ìƒëŒ€ ë©”ì„¸ì§€ì¸ì§€ êµ¬ë¶„í•˜ê¸° ìœ„í•¨)
            onMounted(() => {
                // Thymeleafê°€ ë Œë”ë§í•œ hidden inputì—ì„œ í˜„ì¬ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì˜´
                currentUserId.value = document.querySelector("input[name='id']").value;
            });

            const enterRoom = (room) => {
                currentRoom.value = room;
                messages.splice(0);
                let payload={
                    requestType: "enterRoom",
                    uuid: room.uuid
                }
                request(JSON.stringify(payload));
            };

            const leaveRoom = () => {
                currentRoom.value = null;
                // TODO: ë°©ì—ì„œ ë‚˜ê°€ëŠ” WebSocket ìš”ì²­ ë¡œì§ ì¶”ê°€
            };

            // WebSocket ê´€ë ¨ ë¡œì§
            const connect = () => {
                ws = new WebSocket('ws://192.168.60.37:8989/chat/multi');

                ws.onopen = () => {
                    console.log("WebSocket Connected");
                };

                ws.onmessage = (e) => {
                    console.log("Message received:", e.data);
                    const responseJson = JSON.parse(e.data);

                    if(responseJson.responseType == "connect" || responseJson.responseType == "createRoom"){
                        //ì ‘ì†ì ëª…ë‹¨ ì±„ìš°ê¸°
                        memberList.splice(0); // ë°°ì—´ ë¹„ìš°ê¸°
                        responseJson.memberList.forEach(member => {
                            memberList.push(member);
                        });

                        //ì±„íŒ…ë°© ëª©ë¡ ì±„ìš°ê¸°
                        roomList.splice(0); // ë°°ì—´ ë¹„ìš°ê¸°
                        if(responseJson.roomList != null){
                            responseJson.roomList.forEach(room => {
                                roomList.push(room);
                            });
                        }
                    }else if(responseJson.responseType == "enterRoom"){
                        console.log(responseJson);
                        uuid.value = responseJson.room.uuid;
                    }else if(responseJson.responseType == "leaveRoom"){

                    }else if(responseJson.responseType == "chat"){
                        const newMessage = {
                            id : responseJson.messageId,
                            senderId : responseJson.senderId,
                            senderName : responseJson.senderName,
                            text : responseJson.data
                        };
                        addMessage(newMessage);

                    }
                    // TODO: ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹  ë“± ë‹¤ë¥¸ íƒ€ì…ì˜ ë©”ì‹œì§€ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
                };
            };

            const disconnect = () => {
                ws.disconnect();
            }

            const request = (data) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(data);
                } else {
                    console.error("WebSocket is not connected.");
                }
            };

            const createRoom = () => {
                const roomNameInput = $("input[name='roomName']");
                if (!roomNameInput.val()) {
                    alert("ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                let payload = {
                    requestType:"createRoom",
                    userId:$("input[name='id']").val(),
                    roomName: roomNameInput.val(),
                };
                request(JSON.stringify(payload));
                roomNameInput.val(''); // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            };

            const sendMessage = () => {
                if (!msg.value || msg.value.trim() === "") {
                    return; // ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìœ¼ë©´ í•¨ìˆ˜ë¥¼ ê·¸ëƒ¥ ì¢…ë£Œ
                }
                let payload = {
                    requestType: "chat",
                    senderId:$("input[name='id']").val(),
                    senderName:$("input[name='senderName']").val(),
                    data:msg.value,
                    uuid: uuid.value
                }
                request(JSON.stringify(payload));
                msg.value = ""; //ë°”ì¸ë”© ë³€ìˆ˜ì´ë¯€ë¡œ UIì— ìë™ ë°˜ì˜.
            }

            connect();

            // í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©í•  ë°ì´í„°ì™€ í•¨ìˆ˜ë“¤ì„ ë°˜í™˜
            return {
                memberList,
                roomList,
                request,
                connect,
                createRoom,
                sendMessage,
                msg,
                uuid,
                messages,
                currentUserId,
                messageContainer,
                addMessage,

                // ğŸ¨ [ì¶”ê°€] UI ì œì–´ìš© ìƒíƒœì™€ í•¨ìˆ˜ ë°˜í™˜
                currentRoom,
                enterRoom,
                leaveRoom,
                disconnect

            };
        }
    }).mount("#app");
</script>
</body>
</html>