<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body style="background-color: rgb(240, 240, 240);">
    <button type="button" onClick="getMyInfo()">나의 정보 얻어오기</button>
    <button type="button" onClick="logout()">로그 아웃</button>

    <script>
        //서버측에서 401 (UnAuthorized) status 코드를 전송받으면
        //만료된 AccessToken 에 대한 재발급 요청
        function refreshToken(){

        }

        function getMyInfo(){
            //로그인 시점에 저장해놓은 accessToken 꺼내기
            const token = localStorage.getItem("accessToken");
            $.ajax({
                url:"/member/myinfo",
                method:"GET",
                headers:{
                    "Authorization" : "Bearer "+token
                },
                success:function(data){
                    console.log(data);
                },
                error:function(xhr){
                    if(xhr.status == 401){
                        //나의 정보를 요청하던 중, 401을 만났으므로 , 토큰 만료 가능성이 높음...
                        //따라서 유저가 알아채지 못하게 몰래 , 토큰 재발급을 요청할 것임..
                        console.log("엑세스 토큰 만료로 인하여 재발급 몰래 받기 시도할 예정");
                        tryAccessToken();
                    }
                }
            });
        }

        //리프레시 토큰을 이용한 accessToken 재발급
        //유효한 refresh 토큰을 이용하여 accesstoken 요청
        function tryAccessToken(){
            $.ajax({
                url:"/member/refresh",
                method:"post",
                contentType:"application/json; charset=UTF-8",
                data:JSON.stringify({
                    deviceId:localStorage.getItem("deviceId")
                }),
                xhrFields: {
                    withCredentials: true   // ← 이거 추가해야 쿠키도 같이 전송됨
                },
                success:function(data){
                    //새롭게 발급된 accessToken 확인
                    console.log("새롭게 발급받은 accessToken" , data.accessToken);

                    //사라지기 전에 저장소 보관
                    localStorage.setItem("accessToken",data.accessToken);
                },
                error:function(xhr){
                    console.log(xhr.responseText);
                }
            });
        }

        function logout(){
            const accessToken = localStorage.getItem("accessToken");
            const deviceId = localStorage.getItem("deviceId");

            $.ajax({
                url:"/member/logout",
                method:"POST",
                contentType:"application/json;charset=UTF-8",
                data:JSON.stringify({
                    accessToken:accessToken,
                    deviceId:deviceId
                }),
                success:function(data){
                    //로컬 상에 보유한 데이터 삭제
                    localStorage.removeItem("accessToken");
                    localStorage.removeItem("deviceId");
                    alert("로그아웃 되었습니다.")
                    location.href="/member/login.html";
                },
                error:function(xhr){
                    console.log(xhr.responseText);
                }
            });
        }
    </script>

</body>
</html>